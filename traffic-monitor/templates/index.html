<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="refresh" content="10">
    <title>Network Traffic Monitor - Live Updates</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #e6e6e6;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .subtitle { color: #b0bec5; font-size: 0.9em; }
        .grid {
            display: grid;
            gap: 20px;
        }
        .grid.two {
            grid-template-columns: repeat(auto-fit, minmax(420px, 1fr));
        }
        .grid.three {
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        }
        .panel {
            background: rgba(37, 43, 58, 0.95);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.05);
        }
        .panel h2 {
            margin-bottom: 15px;
            color: #81c784;
            border-bottom: 2px solid #81c784;
            padding-bottom: 10px;
        }
        .refresh-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 15px;
        }
        .refresh-btn:hover { background: #45a049; }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        th {
            background: #2d3748;
            color: #fff;
            padding: 10px;
            text-align: left;
            font-weight: bold;
            position: sticky;
            top: 0;
        }
        td {
            padding: 8px;
            border-bottom: 1px solid #2d3748;
        }
        tr:hover { background: rgba(255,255,255,0.05); }
        .ip-address { color: #4fc3f7; font-weight: bold; }
        .severity-high { color: #f44336; font-weight: bold; }
        .severity-medium { color: #ff9800; font-weight: bold; }
        .severity-low { color: #4caf50; font-weight: bold; }
        .cards { display: grid; gap: 12px; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); margin-bottom: 16px; }
        .card { background: rgba(255,255,255,0.04); border-radius: 8px; padding: 12px 14px; border: 1px solid rgba(255,255,255,0.05); }
        .card-title { font-size: 12px; color: #b0bec5; margin-bottom: 6px; }
        .card-value { font-size: 22px; font-weight: 700; }
        .chart-wrap { background: rgba(255,255,255,0.02); border-radius: 8px; padding: 10px; border: 1px solid rgba(255,255,255,0.05); }
        .section-title { font-size: 13px; color: #b0bec5; margin: 8px 0; }
        .controls { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
        select, option { background: #2d3748; color: #fff; border: 1px solid #455a64; padding: 6px 8px; border-radius: 6px; font-size: 12px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üåê Network Traffic Monitor</h1>
        <p class="subtitle">Suricata IDS/IPS & Zeek Network Analysis + Tcpdump Capture - Hotspot Network (wlan0) - Sensor vs Kali Attacker</p>
    </div>

    <!-- Suricata Panel (Full Width) -->
    <div class="panel" style="margin-bottom: 20px;">
        <h2>üõ°Ô∏è Suricata - All Network Events</h2>
        <div class="controls">
            <button class="refresh-btn" onclick="loadSuricataAll()">Refresh</button>
                <label style="font-size:12px;color:#b0bec5;">Filter by Type:</label>
                <select id="suricata-filter" onchange="renderSuricataTable()">
                    <option value="all">All Events</option>
                    <option value="alert">Alert</option>
                    <option value="flow">Flow</option>
                    <option value="netflow">Netflow</option>
                    <option value="http">HTTP</option>
                    <option value="dns">DNS</option>
                    <option value="tls">TLS</option>
                    <option value="ssh">SSH</option>
                    <option value="files">Files</option>
                </select>
            </div>
            
            <div class="cards" id="suricata-cards"></div>
            <div class="grid three">
                <div class="chart-wrap">
                    <div class="section-title">Event Types (last 500)</div>
                    <canvas id="suricata-types"></canvas>
                </div>
                <div class="chart-wrap">
                    <div class="section-title">Alert Severity (last 500)</div>
                    <canvas id="suricata-severity"></canvas>
                </div>
                <div class="chart-wrap">
                    <div class="section-title">Top Source IPs</div>
                    <canvas id="suricata-top-src"></canvas>
                </div>
            </div>
            <div style="overflow-x: auto; max-height: 520px; margin-top:14px;">
                <table id="suricata-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Type</th>
                            <th>Flow ID</th>
                            <th>Src IP:Port</th>
                            <th>Dst IP:Port</th>
                            <th>Proto</th>
                            <th>App Proto</th>
                            <th>Bytes‚Üë</th>
                            <th>Bytes‚Üì</th>
                            <th>Pkts‚Üë</th>
                            <th>Pkts‚Üì</th>
                            <th>Flow State</th>
                            <th>Flow Start</th>
                            <th>Flow End</th>
                            <th>Flow Reason</th>
                            <th>Duration</th>
                            <th>TCP Flags</th>
                            <th>TCP State</th>
                            <th>TCP SYN</th>
                            <th>TCP ACK</th>
                            <th>TCP FIN</th>
                            <th>TCP RST</th>
                            <th>Severity</th>
                            <th>Alert Sig</th>
                            <th>Alert ID</th>
                            <th>Alert Cat</th>
                            <th>Alert Action</th>
                            <th>HTTP Method</th>
                            <th>HTTP Host</th>
                            <th>HTTP URL</th>
                            <th>HTTP Status</th>
                            <th>HTTP UA</th>
                            <th>HTTP Referer</th>
                            <th>HTTP Type</th>
                            <th>DNS Query</th>
                            <th>DNS Type</th>
                            <th>DNS RCode</th>
                            <th>DNS Answers</th>
                            <th>TLS SNI</th>
                            <th>TLS Version</th>
                            <th>TLS Cipher</th>
                            <th>TLS Subject</th>
                            <th>TLS Issuer</th>
                            <th>File Name</th>
                            <th>File Size</th>
                            <th>File Type</th>
                            <th>File MD5</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody id="suricata-tbody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Zeek Panel (Full Width) -->
    <div class="panel" style="margin-bottom: 20px;">
        <h2>üîç Zeek - All Network Analysis</h2>
        <div class="controls">
            <button class="refresh-btn" onclick="loadZeekAll()">Refresh</button>
                <label style="font-size:12px;color:#b0bec5;">Filter by Type:</label>
                <select id="zeek-filter" onchange="renderZeekTable()">
                    <option value="all">All</option>
                    <option value="connection">Connection</option>
                    <option value="http">HTTP</option>
                    <option value="dns">DNS</option>
                    <option value="ssl">SSL</option>
                </select>
            </div>
            
            <div class="cards" id="zeek-cards"></div>
            <div class="grid three">
                <div class="chart-wrap">
                    <div class="section-title">Event Types (last 200)</div>
                    <canvas id="zeek-types"></canvas>
                </div>
                <div class="chart-wrap">
                    <div class="section-title">Protocol Mix</div>
                    <canvas id="zeek-proto"></canvas>
                </div>
                <div class="chart-wrap">
                    <div class="section-title">Top Dest IPs</div>
                    <canvas id="zeek-top-dest"></canvas>
                </div>
            </div>
            <div style="overflow-x: auto; max-height: 520px; margin-top:14px;">
                <table id="zeek-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Type</th>
                            <th>UID</th>
                            <th>Src IP:Port</th>
                            <th>Dst IP:Port</th>
                            <th>Proto</th>
                            <th>Service</th>
                            <th>Orig Bytes</th>
                            <th>Resp Bytes</th>
                            <th>Orig Pkts</th>
                            <th>Resp Pkts</th>
                            <th>Conn State</th>
                            <th>Duration</th>
                            <th>History</th>
                            <th>Missed Bytes</th>
                            <th>Local Orig</th>
                            <th>Local Resp</th>
                            <th>HTTP Method</th>
                            <th>HTTP Host</th>
                            <th>HTTP URI</th>
                            <th>HTTP Status</th>
                            <th>User Agent</th>
                            <th>Trans Depth</th>
                            <th>DNS Query</th>
                            <th>DNS QType</th>
                            <th>DNS RCode</th>
                            <th>DNS Answers</th>
                            <th>SSL Version</th>
                            <th>SSL Cipher</th>
                            <th>SSL Subject</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody id="zeek-tbody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Tcpdump PCAP Capture Panel (Full Width) -->
    <div class="panel">
        <h2>üì° Tcpdump - All Hotspot Traffic Capture (wlan0)</h2>
        <div class="controls">
            <button class="refresh-btn" onclick="loadTcpdumpStats(); loadTcpdumpAllTraffic();">Refresh</button>
                <label style="font-size:12px;color:#b0bec5;">Auto Capture: Rolling 6x50MB files, 5-min rotation | Live on interface wlan0 | Last 2 Hours of Traffic</label>
            </div>
            
            <div style="margin-bottom: 20px;">
                <h3 style="color: #4caf50; margin-bottom: 10px;">üìä PCAP Files Status</h3>
                <div class="cards" id="tcpdump-cards"></div>
                <div style="overflow-x: auto; max-height: 250px;">
                    <table id="tcpdump-table">
                        <thead>
                            <tr>
                                <th>PCAP File</th>
                                <th>Size (MB)</th>
                                <th>Modified Time</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="tcpdump-tbody"></tbody>
                    </table>
                </div>
            </div>
            
            <div>
                <h3 style="color: #81c784; margin-bottom: 10px; margin-top: 20px;">üî¥ All Captured Network Traffic (Last 2 Hours)</h3>
                <div style="overflow-x: auto; max-height: 350px;">
                    <table id="traffic-table">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Source IP:Port</th>
                                <th>Destination IP:Port</th>
                                <th>Protocol</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="traffic-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const charts = {};
        let suricataCache = [];
        let zeekCache = [];

        function loadSuricataAll() {
            fetch('/api/suricata/all')
                .then(r => r.json())
                .then(data => {
                    suricataCache = data || [];
                    renderSuricataTable();
                    renderSuricataCards();
                    renderSuricataCharts();
                })
                .catch(err => console.error('Error loading Suricata:', err));
        }

        function loadZeekAll() {
            fetch('/api/zeek/all')
                .then(r => r.json())
                .then(data => {
                    zeekCache = data || [];
                    renderZeekTable();
                    renderZeekCards();
                    renderZeekCharts();
                })
                .catch(err => console.error('Error loading Zeek:', err));
        }

        function renderSuricataTable() {
            const tbody = document.getElementById('suricata-tbody');
            tbody.innerHTML = '';
            if (!suricataCache.length) {
                tbody.innerHTML = '<tr><td colspan="48" style="text-align: center; color: #95a5a6;">No Suricata events yet</td></tr>';
                return;
            }
            const filter = document.getElementById('suricata-filter').value;
            const filtered = suricataCache.filter(e => filter === 'all' || (e.event_type || '').toLowerCase() === filter);
            filtered.forEach(event => {
                const tr = document.createElement('tr');
                const eventType = event.event_type || 'unknown';
                let timeDisplay = 'N/A';
                if (event.timestamp) {
                    const date = new Date(event.timestamp);
                    timeDisplay = isNaN(date.getTime()) ? event.timestamp : date.toLocaleString();
                }
                let severityDisplay = '-';
                let alertSig = '-';
                if (eventType === 'alert' && event.alert) {
                    if (event.alert.severity !== undefined) {
                        const severity = event.alert.severity;
                        const severityClass = severity >= 3 ? 'severity-high' : severity >= 2 ? 'severity-medium' : 'severity-low';
                        severityDisplay = `<span class="${severityClass}">${severity}</span>`;
                    }
                    alertSig = event.alert.signature || '-';
                }
                
                const flowId = event.flow_id || '-';
                const proto = (event.proto || '-').toUpperCase();
                const appProto = event.app_proto || '-';
                const bytesUp = event.flow?.bytes_toserver || event.netflow?.bytes || '-';
                const bytesDown = event.flow?.bytes_toclient || '-';
                const pktsUp = event.flow?.pkts_toserver || event.netflow?.pkts || '-';
                const pktsDown = event.flow?.pkts_toclient || '-';
                const flowState = event.flow?.state || '-';
                const flowStart = event.flow?.start || '-';
                const flowEnd = event.flow?.end || '-';
                const flowReason = event.flow?.reason || '-';
                const duration = event.flow?.age ? event.flow.age.toFixed(2) + 's' : '-';
                const tcpFlags = event.tcp?.tcp_flags || '-';
                const tcpState = event.tcp?.state || '-';
                const tcpSyn = event.tcp?.syn ? 'Y' : '-';
                const tcpAck = event.tcp?.ack ? 'Y' : '-';
                const tcpFin = event.tcp?.fin ? 'Y' : '-';
                const tcpRst = event.tcp?.rst ? 'Y' : '-';
                const alertId = event.alert?.signature_id || '-';
                const alertCat = event.alert?.category || '-';
                const alertAction = event.alert?.action || '-';
                const httpMethod = event.http?.http_method || '-';
                const httpHost = event.http?.hostname || '-';
                const httpUrl = event.http?.url || '-';
                const httpStatus = event.http?.status || '-';
                const httpUa = event.http?.user_agent || '-';
                const httpReferer = event.http?.referer || '-';
                const httpContentType = event.http?.content_type || '-';
                const dnsQuery = event.dns?.rrname || '-';
                const dnsType = event.dns?.rrtype || '-';
                const dnsRcode = event.dns?.rcode || '-';
                const dnsAnswers = event.dns?.answers ? (Array.isArray(event.dns.answers) ? event.dns.answers.join(', ') : event.dns.answers) : '-';
                const tlsSni = event.tls?.sni || '-';
                const tlsVersion = event.tls?.version || '-';
                const tlsCipher = event.tls?.cipher || '-';
                const tlsSubject = event.tls?.subject || '-';
                const tlsIssuer = event.tls?.issuerdn || '-';
                const fileName = event.fileinfo?.filename || '-';
                const fileSize = event.fileinfo?.size || '-';
                const fileMime = event.fileinfo?.mimetype || event.fileinfo?.magic || '-';
                const fileMd5 = event.fileinfo?.md5 || '-';
                
                let details = '';
                if (eventType === 'alert') details = event.alert?.signature || 'Alert';
                else if (eventType === 'flow') details = 'Flow data';
                else if (eventType === 'netflow') details = 'NetFlow record';
                else if (eventType === 'http') details = `${httpMethod} ${event.http?.url || ''}`;
                else if (eventType === 'dns') details = `${event.dns?.type || ''} query`;
                else if (eventType === 'tls') details = 'TLS handshake';
                else details = eventType;
                
                tr.innerHTML = `
                    <td style="font-size: 11px;">${timeDisplay}</td>
                    <td style="color: #81c784; font-weight: bold; font-size: 11px;">${eventType.toUpperCase()}</td>
                    <td style="font-size: 10px;">${flowId}</td>
                    <td class="ip-address" style="font-size: 11px;">${event.src_ip || 'N/A'}${event.src_port ? ':' + event.src_port : ''}</td>
                    <td class="ip-address" style="font-size: 11px;">${event.dest_ip || 'N/A'}${event.dest_port ? ':' + event.dest_port : ''}</td>
                    <td style="font-size: 11px;">${proto}</td>
                    <td style="font-size: 11px;">${appProto}</td>
                    <td style="font-size: 11px;">${bytesUp}</td>
                    <td style="font-size: 11px;">${bytesDown}</td>
                    <td style="font-size: 11px;">${pktsUp}</td>
                    <td style="font-size: 11px;">${pktsDown}</td>
                    <td style="font-size: 11px;">${flowState}</td>
                    <td style="font-size: 10px;">${flowStart}</td>
                    <td style="font-size: 10px;">${flowEnd}</td>
                    <td style="font-size: 10px;">${flowReason}</td>
                    <td style="font-size: 11px;">${duration}</td>
                    <td style="font-size: 10px;">${tcpFlags}</td>
                    <td style="font-size: 10px;">${tcpState}</td>
                    <td style="font-size: 9px;">${tcpSyn}</td>
                    <td style="font-size: 9px;">${tcpAck}</td>
                    <td style="font-size: 9px;">${tcpFin}</td>
                    <td style="font-size: 9px;">${tcpRst}</td>
                    <td>${severityDisplay}</td>
                    <td style="font-size: 10px;">${alertSig}</td>
                    <td style="font-size: 10px;">${alertId}</td>
                    <td style="font-size: 10px;">${alertCat}</td>
                    <td style="font-size: 10px;">${alertAction}</td>
                    <td style="font-size: 11px;">${httpMethod}</td>
                    <td style="font-size: 11px;">${httpHost}</td>
                    <td style="font-size: 10px;">${httpUrl}</td>
                    <td style="font-size: 10px;">${httpStatus}</td>
                    <td style="font-size: 9px;">${httpUa}</td>
                    <td style="font-size: 9px;">${httpReferer}</td>
                    <td style="font-size: 10px;">${httpContentType}</td>
                    <td style="font-size: 11px;">${dnsQuery}</td>
                    <td style="font-size: 10px;">${dnsType}</td>
                    <td style="font-size: 10px;">${dnsRcode}</td>
                    <td style="font-size: 10px;">${dnsAnswers}</td>
                    <td style="font-size: 11px;">${tlsSni}</td>
                    <td style="font-size: 10px;">${tlsVersion}</td>
                    <td style="font-size: 9px;">${tlsCipher}</td>
                    <td style="font-size: 9px;">${tlsSubject}</td>
                    <td style="font-size: 9px;">${tlsIssuer}</td>
                    <td style="font-size: 10px;">${fileName}</td>
                    <td style="font-size: 10px;">${fileSize}</td>
                    <td style="font-size: 10px;">${fileMime}</td>
                    <td style="font-size: 9px;">${fileMd5}</td>
                    <td style="font-size: 11px;">${details}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderZeekTable() {
            const tbody = document.getElementById('zeek-tbody');
            tbody.innerHTML = '';
            if (!zeekCache.length) {
                tbody.innerHTML = '<tr><td colspan="31" style="text-align: center; color: #95a5a6;">No Zeek logs yet</td></tr>';
                return;
            }
            const filter = document.getElementById('zeek-filter').value;
            const filtered = zeekCache.filter(e => filter === 'all' || (e.type || '').toLowerCase() === filter);
            filtered.forEach(item => {
                const tr = document.createElement('tr');
                const timeDisplay = item.ts ? new Date(parseFloat(item.ts) * 1000).toLocaleString() : 'N/A';
                const typeColors = { connection: '#4caf50', http: '#2196f3', dns: '#ff9800', ssl: '#9c27b0' };
                const typeColor = typeColors[item.type] || '#95a5a6';
                const proto = item.proto ? item.proto.toUpperCase() : '-';
                
                const uid = item.uid || '-';
                const service = item.service || '-';
                const origBytes = item.orig_bytes || 0;
                const respBytes = item.resp_bytes || 0;
                const origPkts = item.orig_pkts || item.orig_ip_bytes || 0;
                const respPkts = item.resp_pkts || item.resp_ip_bytes || 0;
                const connState = item.conn_state || '-';
                const duration = item.duration ? parseFloat(item.duration).toFixed(2) + 's' : '-';
                const history = item.history || '-';
                const missedBytes = item.missed_bytes || 0;
                const localOrig = item.local_orig || '-';
                const localResp = item.local_resp || '-';
                const httpMethod = item.method || '-';
                const httpHost = item.host || '-';
                const httpUri = item.uri || '-';
                const httpStatus = item.status_code || '-';
                const userAgent = item.user_agent || '-';
                const transDepth = item.trans_depth || '-';
                const dnsQuery = item.query || '-';
                const dnsQtype = item.qtype_name || item.qtype || '-';
                const dnsRcode = item.rcode_name || item.rcode || '-';
                const dnsAnswers = item.answers ? (Array.isArray(item.answers) ? item.answers.join(', ') : item.answers) : '-';
                const sslVersion = item.version || '-';
                const sslCipher = item.cipher || '-';
                const sslSubject = item.subject || '-';
                
                let details = '-';
                if (item.type === 'connection') details = `${connState} connection`;
                else if (item.type === 'http') details = `${httpMethod} ${item.uri || ''}`;
                else if (item.type === 'dns') details = `${item.qtype || ''} query`;
                else if (item.type === 'ssl') details = `${item.subject || 'TLS handshake'}`;
                else details = item.details || item.type || '-';
                
                tr.innerHTML = `
                    <td style="font-size: 11px;">${timeDisplay}</td>
                    <td style="color: ${typeColor}; font-weight: bold; font-size: 11px;">${(item.type || '').toUpperCase()}</td>
                    <td style="font-size: 10px;">${uid}</td>
                    <td class="ip-address" style="font-size: 11px;">${item.src_ip || 'N/A'}${item.src_port ? ':' + item.src_port : ''}</td>
                    <td class="ip-address" style="font-size: 11px;">${item.dst_ip || 'N/A'}${item.dst_port ? ':' + item.dst_port : ''}</td>
                    <td style="font-size: 11px;">${proto}</td>
                    <td style="font-size: 11px;">${service}</td>
                    <td style="font-size: 11px;">${origBytes}</td>
                    <td style="font-size: 11px;">${respBytes}</td>
                    <td style="font-size: 11px;">${origPkts}</td>
                    <td style="font-size: 11px;">${respPkts}</td>
                    <td style="font-size: 11px;">${connState}</td>
                    <td style="font-size: 11px;">${duration}</td>
                    <td style="font-size: 10px;">${history}</td>
                    <td style="font-size: 11px;">${missedBytes}</td>
                    <td style="font-size: 10px;">${localOrig}</td>
                    <td style="font-size: 10px;">${localResp}</td>
                    <td style="font-size: 11px;">${httpMethod}</td>
                    <td style="font-size: 11px;">${httpHost}</td>
                    <td style="font-size: 10px;">${httpUri}</td>
                    <td style="font-size: 11px;">${httpStatus}</td>
                    <td style="font-size: 10px;">${userAgent}</td>
                    <td style="font-size: 11px;">${transDepth}</td>
                    <td style="font-size: 11px;">${dnsQuery}</td>
                    <td style="font-size: 10px;">${dnsQtype}</td>
                    <td style="font-size: 10px;">${dnsRcode}</td>
                    <td style="font-size: 10px;">${dnsAnswers}</td>
                    <td style="font-size: 11px;">${sslVersion}</td>
                    <td style="font-size: 10px;">${sslCipher}</td>
                    <td style="font-size: 9px;">${sslSubject}</td>
                    <td style="font-size: 11px;">${details}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function buildChart(id, type, labels, data, colors) {
            const ctx = document.getElementById(id);
            if (charts[id]) charts[id].destroy();
            charts[id] = new Chart(ctx, {
                type,
                data: {
                    labels,
                    datasets: [{
                        data,
                        backgroundColor: colors,
                        borderColor: colors,
                        borderWidth: type === 'bar' ? 1 : 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: type !== 'bar' }, tooltip: { enabled: true } },
                    scales: type === 'bar' ? { x: { ticks: { color: '#e6e6e6' } }, y: { ticks: { color: '#e6e6e6' }, beginAtZero: true } } : {}
                }
            });
        }

        function renderSuricataCards() {
            const wrap = document.getElementById('suricata-cards');
            const total = suricataCache.length;
            const alerts = suricataCache.filter(e => e.event_type === 'alert').length;
            const flows = suricataCache.filter(e => e.event_type === 'flow').length;
            wrap.innerHTML = `
                <div class="card"><div class="card-title">Events (last 500)</div><div class="card-value">${total}</div></div>
                <div class="card"><div class="card-title">Alerts</div><div class="card-value" style="color:#f44336;">${alerts}</div></div>
                <div class="card"><div class="card-title">Flows</div><div class="card-value" style="color:#4fc3f7;">${flows}</div></div>
            `;
        }

        function renderZeekCards() {
            const wrap = document.getElementById('zeek-cards');
            const total = zeekCache.length;
            const conns = zeekCache.filter(e => e.type === 'connection').length;
            const http = zeekCache.filter(e => e.type === 'http').length;
            wrap.innerHTML = `
                <div class="card"><div class="card-title">Events (last 200)</div><div class="card-value">${total}</div></div>
                <div class="card"><div class="card-title">Connections</div><div class="card-value" style="color:#4caf50;">${conns}</div></div>
                <div class="card"><div class="card-title">HTTP</div><div class="card-value" style="color:#2196f3;">${http}</div></div>
            `;
        }

        function renderSuricataCharts() {
            if (!suricataCache.length) return;
            const typeCounts = {};
            const sevCounts = { high:0, medium:0, low:0 };
            const srcCounts = {};
            suricataCache.forEach(e => {
                const t = (e.event_type || 'unknown').toUpperCase();
                typeCounts[t] = (typeCounts[t] || 0) + 1;
                if (e.event_type === 'alert' && e.alert && e.alert.severity !== undefined) {
                    if (e.alert.severity >= 3) sevCounts.high += 1; else if (e.alert.severity >= 2) sevCounts.medium += 1; else sevCounts.low += 1;
                }
                const src = e.src_ip || 'unknown';
                srcCounts[src] = (srcCounts[src] || 0) + 1;
            });
            const topSrc = Object.entries(srcCounts).sort((a,b)=>b[1]-a[1]).slice(0,5);
            buildChart('suricata-types','bar',Object.keys(typeCounts),Object.values(typeCounts),Object.keys(typeCounts).map(()=> '#4fc3f7'));
            buildChart('suricata-severity','doughnut',['High','Medium','Low'],[sevCounts.high, sevCounts.medium, sevCounts.low],['#f44336','#ff9800','#4caf50']);
            buildChart('suricata-top-src','bar',topSrc.map(x=>x[0]),topSrc.map(x=>x[1]),topSrc.map(()=> '#ab47bc'));
        }

        function renderZeekCharts() {
            if (!zeekCache.length) return;
            const typeCounts = {};
            const protoCounts = {};
            const dstCounts = {};
            zeekCache.forEach(e => {
                const t = (e.type || 'unknown').toUpperCase();
                typeCounts[t] = (typeCounts[t] || 0) + 1;
                const p = (e.proto || 'unknown').toUpperCase();
                protoCounts[p] = (protoCounts[p] || 0) + 1;
                const dst = e.dst_ip || 'unknown';
                dstCounts[dst] = (dstCounts[dst] || 0) + 1;
            });
            const topDst = Object.entries(dstCounts).sort((a,b)=>b[1]-a[1]).slice(0,5);
            buildChart('zeek-types','bar',Object.keys(typeCounts),Object.values(typeCounts),Object.keys(typeCounts).map(()=> '#4caf50'));
            buildChart('zeek-proto','doughnut',Object.keys(protoCounts),Object.values(protoCounts),Object.keys(protoCounts).map(()=> '#29b6f6'));
            buildChart('zeek-top-dest','bar',topDst.map(x=>x[0]),topDst.map(x=>x[1]),topDst.map(()=> '#ffa726'));
        }

        // Initial load
        loadSuricataAll();
        loadZeekAll();
        loadTcpdumpStats();
        loadTcpdumpAllTraffic();

        function loadTcpdumpStats() {
            fetch('/api/tcpdump/stats')
                .then(r => r.json())
                .then(data => {
                    renderTcpdumpCards(data);
                    renderTcpdumpTable(data.files);
                })
                .catch(err => console.error('Error loading tcpdump stats:', err));
        }

        function loadTcpdumpAllTraffic() {
            fetch('/api/tcpdump/all-traffic')
                .then(r => r.json())
                .then(data => renderTrafficTable(data.traffic))
                .catch(err => console.error('Error loading traffic:', err));
        }

        function renderTrafficTable(traffic) {
            const tbody = document.getElementById('traffic-tbody');
            tbody.innerHTML = '';
            if (!traffic || traffic.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #95a5a6;">Analyzing PCAP files for traffic data...</td></tr>';
                return;
            }
            traffic.forEach(entry => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="font-size: 11px; color: #4fc3f7;">${entry.time || 'N/A'}</td>
                    <td style="font-size: 11px; color: #81c784; font-weight: bold;">${entry.source || 'N/A'}</td>
                    <td style="font-size: 11px; color: #ffa726; font-weight: bold;">${entry.destination || 'N/A'}</td>
                    <td style="font-size: 11px; color: #ff9800; font-weight: bold;">${entry.protocol || 'N/A'}</td>
                    <td style="font-size: 11px; color: #b0bec5;">${entry.info || '-'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderTcpdumpCards(data) {
            const wrap = document.getElementById('tcpdump-cards');
            wrap.innerHTML = `
                <div class="card"><div class="card-title">Total PCAP Files</div><div class="card-value" style="color:#ffa726;">${data.total_files}</div></div>
                <div class="card"><div class="card-title">Total Captured (MB)</div><div class="card-value" style="color:#29b6f6;">${data.total_size_mb}</div></div>
                <div class="card"><div class="card-title">Interface</div><div class="card-value" style="color:#4caf50;">wlan0</div></div>
                <div class="card"><div class="card-title">Status</div><div class="card-value" style="color:#81c784;">LIVE</div></div>
            `;
        }

        function renderTcpdumpTable(files) {
            const tbody = document.getElementById('tcpdump-tbody');
            tbody.innerHTML = '';
            if (!files || files.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #95a5a6;">No PCAP files captured yet. Waiting for network traffic...</td></tr>';
                return;
            }
            files.forEach(file => {
                const tr = document.createElement('tr');
                const modTime = new Date(file.modified).toLocaleString();
                tr.innerHTML = `
                    <td style="font-size: 11px; color: #4fc3f7; font-weight: bold;">${file.filename}</td>
                    <td style="font-size: 11px; color: #ffa726;">${file.size_mb} MB</td>
                    <td style="font-size: 11px;">${modTime}</td>
                    <td style="font-size: 11px; color: #4caf50;">‚úì Captured</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Auto-refresh every 10 seconds (show live updates)
        setInterval(() => {
            loadSuricataAll();
            loadZeekAll();
            loadTcpdumpStats();
            loadTcpdumpAllTraffic();
        }, 10000);
    </script>
</body>
</html>

