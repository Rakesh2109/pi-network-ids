services:
  # MQTT Broker
  mqtt:
    image: eclipse-mosquitto:latest
    container_name: mqtt-broker
    environment:
      - TZ=Europe/Oslo
    ports:
      - "1883:1883"      # MQTT
      - "9001:9001"      # WebSocket
    volumes:
      - ./mqtt/config:/mosquitto/config
      - ./mqtt/data:/mosquitto/data
      - ./mqtt/log:/mosquitto/log
    networks:
      - monitoring
    restart: unless-stopped

  # InfluxDB - Time series database
  influxdb:
    image: influxdb:2.7
    container_name: influxdb
    ports:
      - "8086:8086"
    environment:
      - TZ=Europe/Oslo
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=admin123
      - DOCKER_INFLUXDB_INIT_ORG=pi_server
      - DOCKER_INFLUXDB_INIT_BUCKET=sensor_data
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=my-super-secret-admin-token
    volumes:
      - ./influxdb/data:/var/lib/influxdb2
      - ./influxdb/config:/etc/influxdb2
    networks:
      - monitoring
    restart: unless-stopped

  # MQTT Data Collector - Stores sensor data to InfluxDB
  mqtt-collector:
    build: ./mqtt-collector
    container_name: mqtt-collector
    depends_on:
      - mqtt
      - influxdb
    environment:
      - TZ=Europe/Oslo
      - MQTT_BROKER=mqtt
      - MQTT_PORT=1883
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=my-super-secret-admin-token
      - INFLUXDB_ORG=pi_server
      - INFLUXDB_BUCKET=sensor_data
    volumes:
      - ./mqtt-collector/logs:/app/logs
    networks:
      - monitoring
    restart: unless-stopped

  # Telegraf - System and Docker metrics collector
  telegraf:
    image: telegraf:latest
    container_name: telegraf
    user: "0:985"
    network_mode: host
    environment:
      - TZ=Europe/Oslo
      - HOST_PROC=/host/proc
      - HOST_SYS=/host/sys
      - HOST_ETC=/host/etc
      - HOST_MOUNT_PREFIX=/host
    volumes:
      - ./telegraf/config/telegraf.conf:/etc/telegraf/telegraf.conf:ro
      - ./telegraf/data:/data/telegraf
      - ./telegraf/start.sh:/start.sh:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /sys:/host/sys:ro
      - /proc:/host/proc:ro
      - /etc:/host/etc:ro
      - /:/host:ro
    entrypoint: /bin/sh
    command: /start.sh
    depends_on:
      - influxdb
    restart: unless-stopped

  # Loki - Log aggregation
  loki:
    image: grafana/loki:latest
    container_name: loki
    user: "0:0"
    environment:
      - TZ=Europe/Oslo
    ports:
      - "3100:3100"
    command: -config.file=/etc/loki/local-config.yaml -validation.allow-structured-metadata=false
    volumes:
      - ./loki/config:/etc/loki
      - ./loki/data:/loki
    networks:
      - monitoring
    restart: unless-stopped

  # Promtail - Log shipper for Loki
  promtail:
    image: grafana/promtail:latest
    container_name: promtail
    volumes:
      - ./promtail/config:/etc/promtail
      - ./suricata/logs:/var/log/suricata:ro
      - ./zeek/logs:/var/log/zeek:ro
      - ./mqtt/log:/var/log/mqtt:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock
    command: -config.file=/etc/promtail/config.yml
    networks:
      - monitoring
    restart: unless-stopped
    depends_on:
      - loki

  # Grafana - Visualization
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    user: "0:0"
    ports:
      - "128.39.201.47:3000:3000"
    environment:
      - TZ=Europe/Oslo
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin123
      - GF_INSTALL_PLUGINS=
      - GF_SERVER_HTTP_ADDR=0.0.0.0
      - GF_SERVER_DOMAIN=*
    volumes:
      - ./grafana/data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
    networks:
      - monitoring
    depends_on:
      - loki
      - influxdb
    restart: unless-stopped

  # Suricata - Network IDS/IPS (Captures all hotspot traffic on wlan0)
  suricata:
    build: ./suricata
    container_name: suricata
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - SYS_NICE
    network_mode: host
    volumes:
      - ./suricata/config:/etc/suricata
      - ./suricata/logs:/var/log/suricata
      - ./suricata/rules:/var/lib/suricata/rules
    environment:
      - CAPTURE_INTERFACE=wlan0
    restart: unless-stopped
    privileged: true

  # Zeek - Network analysis framework
  zeek:
    build: ./zeek
    container_name: zeek
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - SYS_PTRACE
    network_mode: host
    volumes:
      - ./zeek/config:/usr/local/zeek/etc
      - ./zeek/logs:/usr/local/zeek/logs
      - ./zeek/scripts:/usr/local/zeek/share/zeek/site/scripts
    environment:
      - TZ=Europe/Oslo
      - CAPTURE_INTERFACE=wlan0
      - ZEEK_LOG_PATH=/usr/local/zeek/logs
    restart: unless-stopped
    privileged: true

  # Tcpdump - PCAP capture for ALL hotspot traffic (wlan0)
  tcpdump:
    image: nicolaka/netshoot:latest
    container_name: tcpdump
    environment:
      - TZ=Europe/Oslo
    command: >
      sh -c 'apk add --no-cache tzdata >/dev/null 2>&1; export TZ=Europe/Oslo; 
      FILENAME=/pcap/trace-$$(date +%Y-%m-%d_%H-%M-%S).pcap && 
      tcpdump -i wlan0 -nn -C 1024 -w $$FILENAME'
    network_mode: host
    cap_add:
      - NET_ADMIN
      - NET_RAW
    volumes:
      - ./pcap:/pcap
    restart: unless-stopped
    privileged: true

  # Traffic Monitor - Dashboard for Suricata and Zeek
  traffic-monitor:
    build: ./traffic-monitor
    container_name: traffic-monitor
    environment:
      - TZ=Europe/Oslo
    ports:
      - "128.39.201.47:8080:8080"
    volumes:
      - ./suricata/logs:/data/suricata:ro
      - ./zeek/logs:/data/zeek:ro
    networks:
      - monitoring
    depends_on:
      - suricata
      - zeek
    restart: unless-stopped

networks:
  monitoring:
    driver: bridge

volumes:
  influxdb_data:
  loki_data:
  grafana_data:

