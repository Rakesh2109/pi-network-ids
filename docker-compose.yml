services:
  # MQTT Broker
  mqtt:
    image: eclipse-mosquitto:latest
    container_name: mqtt-broker
    environment:
      - TZ=Europe/Oslo
    ports:
      - "1883:1883"      # MQTT
      - "9001:9001"      # WebSocket
    volumes:
      - ./mqtt/config:/mosquitto/config
      - ./mqtt/data:/mosquitto/data
      - ./mqtt/log:/mosquitto/log
    networks:
      - monitoring
    restart: unless-stopped

  # InfluxDB - Time series database
  influxdb:
    image: influxdb:2.7
    container_name: influxdb
    ports:
      - "8086:8086"
    environment:
      - TZ=Europe/Oslo
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=admin123
      - DOCKER_INFLUXDB_INIT_ORG=pi_server
      - DOCKER_INFLUXDB_INIT_BUCKET=sensor_data
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=my-super-secret-admin-token
    volumes:
      - ./influxdb/data:/var/lib/influxdb2
      - ./influxdb/config:/etc/influxdb2
    networks:
      - monitoring
    restart: unless-stopped

  # MQTT Data Collector - Stores sensor data to InfluxDB
  mqtt-collector:
    build: ./mqtt-collector
    container_name: mqtt-collector
    depends_on:
      - mqtt
      - influxdb
    environment:
      - TZ=Europe/Oslo
      - MQTT_BROKER=mqtt
      - MQTT_PORT=1883
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=my-super-secret-admin-token
      - INFLUXDB_ORG=pi_server
      - INFLUXDB_BUCKET=sensor_data
    volumes:
      - ./mqtt-collector/logs:/app/logs
    networks:
      - monitoring
    restart: unless-stopped

  # Telegraf - System and Docker metrics collector
  telegraf:
    image: telegraf:latest
    container_name: telegraf
    user: "0:985"
    network_mode: host
    environment:
      - TZ=Europe/Oslo
      - HOST_PROC=/host/proc
      - HOST_SYS=/host/sys
      - HOST_ETC=/host/etc
      - HOST_MOUNT_PREFIX=/host
    volumes:
      - ./telegraf/config/telegraf.conf:/etc/telegraf/telegraf.conf:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /sys:/host/sys:ro
      - /proc:/host/proc:ro
      - /etc:/host/etc:ro
      - /:/host:ro
    depends_on:
      - influxdb
    restart: unless-stopped

  # Grafana - Visualization
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    user: "0:0"
    ports:
      - "0.0.0.0:3000:3000"
    environment:
      - TZ=Europe/Oslo
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin123
      - GF_INSTALL_PLUGINS=
      - GF_SERVER_HTTP_ADDR=0.0.0.0
      - GF_SERVER_DOMAIN=*
    volumes:
      - ./grafana/data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
    networks:
      - monitoring
    depends_on:
      - influxdb
    restart: unless-stopped

  # Tcpdump - PCAP capture for ALL hotspot traffic (wlan0)
  tcpdump:
    image: nicolaka/netshoot:latest
    container_name: tcpdump
    network_mode: host
    cap_add:
      - NET_ADMIN
      - NET_RAW
    command: >
      tcpdump -i wlan0 -C 100 -W 10 -w /pcap/trace.pcap -n
    volumes:
      - ./pcap:/pcap
    restart: unless-stopped
    privileged: true

  # ntopng - Real-time network traffic monitoring (ARM64)
  ntopng:
    image: ntop/ntopng_arm64.dev:latest
    container_name: ntopng
    network_mode: host
    cap_add:
      - NET_ADMIN
      - NET_RAW
    environment:
      - TZ=Europe/Oslo
      - NTOPNG_HTTP_PORT=3001
    volumes:
      - ./ntopng/data:/var/lib/ntopng
    restart: unless-stopped
    privileged: true

networks:
  monitoring:
    driver: bridge

volumes:
  influxdb_data:
  grafana_data:

